<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tracked Controls</title>
    <meta name="description" content="Tracked Controls â€“ A-Frame">
    <!-- <script src="../../../dist/aframe-master.js"></script> -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  
    <script src="components/aabb-collider.js"></script>
    <script src="components/grab.js"></script>
    <script src="components/ground.js"></script>
    <script src="shaders/skyGradient.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.0.1/dist/aframe-event-set-component.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/aframe-look-at-component@1.0.0/index.min.js"></script>

  <script>
console.log("STARTUP!")

const VELOCITY_ON = false;

const ANIM_DELAY_MS = 1000;
const FADEOUT_MS = 1000;

const MAX_PARTICLES = 80;
const VEL_FACTOR = 0.5;

//THROWINGG.
const THROW_ACCEL_FACTOR = 0.05;
const MAX_THROW_VELOCITY = 0.07; //how fast it can go.
const THROW_VEL_THRESHOLD = 0.05; //throw this hard to get it to go.

const COLOR_LEFT = "#0000cc"
const COLOR_RIGHT = "#006699"

const COLORS = ["grey","white","black","yellow","green","blue","red"];//,"pink"
const SIZES = [0.005, 0.01, 0.1, 0.2, 0.4]
var gColorLeftIndex = 4;
var gColorRightIndex = 5;

var gSizeLeftIndex = 1;
var gSizeRightIndex = 0;

var gTriggerLeftDown = false;
var gTriggerRightDown = false;

var gGripLeftDown = false;
var gGripRightDown = false;

var gThrowingLeft = false;
var gThrowingRight = false;

var gThrowingLeftVel = new THREE.Vector3();
var gThrowingRightVel = new THREE.Vector3();

var gThrowingLeftPos = new THREE.Vector3();
var gThrowingRightPos = new THREE.Vector3();

var gThrownLeftPos = new THREE.Vector3();
var gThrownRightPos = new THREE.Vector3();


function throwElement(hand){
  console.log("throwElement: " + hand)

  if (hand=="left"){
    if (!gThrowingLeft){
      gThrowingLeftVel = velLeft;
      gThrowingLeftPos = document.querySelector('#hand-left').getAttribute('position');
      gThrownLeftPos.copy(gThrowingLeftPos)
      gThrowingLeft = true;
    }
    
  }else{
    if (!gThrowingRight){
      gThrowingRightVel = velRight
      gThrowingRightPos = document.querySelector('#hand-right').getAttribute('position');
      gThrownRightPos.copy(gThrowingRightPos)
      gThrowingRight = true;
    }
   

  }


}

function createTrailGlowstick(newPos, color, lastPos, hand, newVel, bCreateTriangle){

  var sceneEl = document.querySelector('a-scene');

  var groupEl = document.createElement('a-entity');
  sceneEl.appendChild(groupEl);

  if (true || bCreateTriangle){

  var newEl1 = document.createElement('a-cone');

  var distance = lastPos.distanceTo(newPos)
  var height = distance * 2;
  //ghetto way to trim the long connectors when mouse position moves.
  if (height > 0.3){
    height = 0;
  }

  groupEl.appendChild(newEl1);
  newEl1.setAttribute('color', color);
  newEl1.setAttribute('material','side: double; transparent: false;')
  newEl1.setAttribute('geometry', {
    primitive: 'cone',
    radiusTop: 0.1,
    radiusBottom: 0.1,
    height: height,
    segmentsRadial: 9,
    segmentsHeight: 3,
    openEnded: false,
  });
  groupEl.setAttribute('position', newPos);
  newEl1.setAttribute('rotation', '90 0 0');

   
  groupEl.setAttribute("look-at",  lastPos);

  // console.log("newPos:" + JSON.stringify(newPos))
  // console.log("lastPos:" + JSON.stringify(lastPos))

}//if


  newEl1.setAttribute('animation__radius_shrink', {
    property: 'geometry.radiusTop',
    dur: FADEOUT_MS,
    delay: ANIM_DELAY_MS,
    easing: 'easeOutQuad',
    to: 0
  })

  newEl1.setAttribute('animation__radius2_shrink', {
    property: 'geometry.radiusBottom',
    dur: FADEOUT_MS,
    delay: ANIM_DELAY_MS,
    easing: 'easeOutQuad',
    to: 0
  })

  //Destroy old one and register new one

  if (hand=="left"){

    if (aParticlesLeft[iParticleLeft]){
      var el = aParticlesLeft[iParticleLeft];
      el.parentNode.removeChild(el);
    }
    aParticlesLeft[iParticleLeft] = groupEl;
    iParticleLeft ++;
    if (iParticleLeft>MAX_PARTICLES){
      iParticleLeft = 0;
    } 

  }else{

    if (aParticlesRight[iParticleRight]){
      var el = aParticlesRight[iParticleRight];
      el.parentNode.removeChild(el);
    }
    aParticlesRight[iParticleRight] = groupEl;
    iParticleRight ++;
    if (iParticleRight>MAX_PARTICLES){
      iParticleRight = 0;
    } 

  }


}







    var aParticlesLeft = [];
    var aParticlesRight = [];
    
    var iParticleLeft = 0;
    var iParticleRight = 0;

    
    //var l1 = new THREE.Vector3()
    var lastPosLeft = new THREE.Vector3()
    var lastPosRight = new THREE.Vector3()

    function calcVelocity(aPos, pos){

      if (pos.length()>0){
        aPos.push(pos);
      }
      

      if (aPos.length > MAX_POS){
        aPos.shift();
      }

      var vel = new THREE.Vector3();
      if (aPos.length > 1){
        vel.subVectors(pos, aPos[0]);
        vel.multiplyScalar(VEL_FACTOR);
        //console.log("vel: " + JSON.stringify(vel))
      }
 

      return vel;
    }

    var MAX_POS = 3;
    var aPosLeft = []
    var aPosRight = []
    var aPosCursor = []
    
    var velCursor = {"x":0,"y":0,"z":0};
    var velLeft = new THREE.Vector3();
    var velRight = new THREE.Vector3();

    function incrementColor(hand,color){
      return false;

      // color++;
      // if (color >= COLORS.length){
      //   color = 0;
      // }
      if (hand=="left"){
        gColorLeftIndex++;
        if (gColorLeftIndex >= COLORS.length){
          gColorLeftIndex = 0;
        }
      }else{
        gColorRightIndex++;
        if (gColorRightIndex >= COLORS.length){
          gColorRightIndex = 0;
        }
      }

    }

    function incrementSize(hand){
      return false;

      incrementColor(hand);

      var f,p, point;
      if (hand=="left"){
        gSizeLeftIndex++;
        if (gSizeLeftIndex >= SIZES.length){
          gSizeLeftIndex = 0;
        }

        f = SIZES[gSizeLeftIndex];
        p = {'x':0, 'y':f*3, 'z':-f*2}
        
        point = document.querySelector('#glowstick-left-2'); 
        point.setAttribute('position', p)
        



      }else{
        gSizeRightIndex++;
        if (gSizeRightIndex >= SIZES.length){
          gSizeRightIndex = 0;
        }

        f = SIZES[gSizeRightIndex];
        p = {'x':0, 'y':f*3, 'z':-f*2}
        
        point = document.querySelector('#glowstick-right-2'); 
        point.setAttribute('position', p)
        
      }

    }

      // Component to change to a sequential color on click.
    AFRAME.registerComponent('cursor-listener', {
      tick: function (){
        //var el = this.el;
        

        //console.log("x:" + velCursor.x);
        //console.log("c:" + aPosCursor.length);

      },
      init: function () {
        // this.el.addEventListener('click', function (evt) {
        //   //this.setAttribute('material', 'color', COLORS[lastIndex]);
        this.el.addEventListener('mousedown', function (evt) {
          gIsMouseDown = true;
        });
        this.el.addEventListener('mouseup', function (evt) {
          gIsMouseDown = false;
        });
      }
    });

    AFRAME.registerComponent('button-listener-left', {

      tick: function (){
        // var el = this.el;
        // var cameraPostion = new THREE.Vector3();
        // var posLeft = el.object3D.getWorldPosition(cameraPostion)
        // var velLeft = calcVelocity(aPosLeft, posLeft)

        // iPosLeft ++;
        // if (iPosLeft > MAX_POS){
        //   iPosLeft = 0;
        // }
        // aPosLeft[iPosLeft] = posLeft;

      },

      init: function () {
        var el = this.el;
        // el.addEventListener('xbuttondown', function (evt) {
        //   var newPos = el.object3D.getWorldPosition();
        //   createTrail(newPos)
        // });
        el.addEventListener('xbuttondown', function (evt) {
          gXButtonDown = true;
          incrementColor("left", gColorLeftIndex);
        });
        el.addEventListener('xbuttonup', function (evt) {
          gXButtonDown = false;
        });
        el.addEventListener('ybuttondown', function (evt) {
          gYButtonDown = true;
          // incrementColor("left", gColorLeftIndex);
        });
        el.addEventListener('ybuttonup', function (evt) {
          gYButtonDown = false;
        });

        el.addEventListener('triggerdown', function (evt) {
          gTriggerLeftDown = true;
        });        
        el.addEventListener('triggerup', function (evt) {
          gTriggerLeftDown = false;
        });

        el.addEventListener('gripdown', function (evt) {
          gGripLeftDown = true;
          gThrowingLeft = true;
          throwElement("left");
          incrementSize("left");
        });        
        el.addEventListener('gripup', function (evt) {
          gGripLeftDown = false;
          gThrowingLeft = false;
        });

      }
    });

AFRAME.registerComponent('button-listener-right', {

    // tick: function (){
    //   var el = this.el;
    //   //var velLeft = calcVelocity(aPosLeft, posLeft)

    // },

    init: function () {
      var el = this.el;
      // el.addEventListener('xbuttondown', function (evt) {
      //   var newPos = el.object3D.getWorldPosition();
      //   createTrail(newPos)
      // });

      el.addEventListener('abuttondown', function (evt) {
        gAButtonDown = true;
        incrementColor("right", gColorRightIndex);
      });
      el.addEventListener('abuttonup', function (evt) {
        gAButtonDown = false;
      });
      el.addEventListener('bbuttondown', function (evt) {
        gBButtonDown = true;
        // incrementColor("right", gColorRightIndex);
      });
      el.addEventListener('bbuttonup', function (evt) {
        gBButtonDown = false;
      });

      el.addEventListener('triggerdown', function (evt) {
          gTriggerRightDown = true;
        });        
        el.addEventListener('triggerup', function (evt) {
          gTriggerRightDown = false;
        });

        el.addEventListener('gripdown', function (evt) {
          gGripRightDown = true;
          gThrowingRight = true;
          throwElement("right");
          incrementSize("right");
        });        
        el.addEventListener('gripup', function (evt) {
          gGripRightDown = false;
          gThrowingRight = false;
        });
    }
});


    var gIsMouseDown = false;

    var gXButtonDown = false;
    var gYButtonDown = false;
    var gAButtonDown = false;
    var gBButtonDown = false;


    // GAME LOOP
    const TICKS_PER_FRAME = 20;



    var myVar = setInterval(function(){
      
      //Cursor
      // if (gIsMouseDown){
      //   var cursor = document.querySelector('#a-cursor'); 
      //   if (cursor.components.raycaster.intersections.length == 0){
      //     return; 
      //   }
      //   var intersection = cursor.components.raycaster.intersections[0];
      //   var intersectionPosition = intersection.point;
      // }


    
      //Controllers
      var handLeft = document.querySelector('#hand-left'); 
      var posLeft = new THREE.Vector3();
      handLeft.object3D.getWorldPosition(posLeft)
      velLeft = calcVelocity(aPosLeft, posLeft);
      

      if (velLeft.length() > THROW_VEL_THRESHOLD){
        
        throwElement("left")
      }
      if (gThrowingLeft){     
        //adjust valocity
        var gThrowingLeftAccel = new THREE.Vector3().subVectors(posLeft, gThrownLeftPos).multiplyScalar(THROW_ACCEL_FACTOR)
        gThrowingLeftVel = new THREE.Vector3().addVectors(gThrowingLeftAccel, gThrowingLeftVel).clampLength(0,MAX_THROW_VELOCITY)
        
        //adjust position
        gThrowingLeftPos = new THREE.Vector3().addVectors(gThrowingLeftVel, gThrowingLeftPos)
        posLeft = gThrowingLeftPos.clone();
        //console.log("throwingLeft pos:" +  posLeft.length());
      }

      var handRight = document.querySelector('#hand-right'); 
      var posRight = new THREE.Vector3();
      handRight.object3D.getWorldPosition(posRight)
      velRight = calcVelocity(aPosRight, posRight);
      if (velRight.length() > THROW_VEL_THRESHOLD){
        throwElement("right")
      }
      if (gThrowingRight){    
        
        //adjust valocity
        var gThrowingRightAccel = new THREE.Vector3().subVectors(posRight, gThrownRightPos).multiplyScalar(THROW_ACCEL_FACTOR)
        gThrowingRightVel = new THREE.Vector3().addVectors(gThrowingRightAccel, gThrowingRightVel).clampLength(0,MAX_THROW_VELOCITY)
        
        //adjust position
        gThrowingRightPos = new THREE.Vector3().addVectors(gThrowingRightVel, gThrowingRightPos)
        posRight = gThrowingRightPos.clone();
        //console.log("throwingLeft pos:" +  posLeft.length());
      }


      //LEFT
      if (gTriggerLeftDown){ 
 
        var ballLeft = document.querySelector('#sphere-left');
        ballLeft.setAttribute("position",posLeft)

        var distance = lastPosLeft.distanceTo(posLeft)
        if (distance > 0.01){
          document.querySelector('#glowstick-left-1').object3D.getWorldPosition(lastPosLeft);
        }
        var eLeft = document.querySelector('#glowstick-left'); 
        eLeft.setAttribute('position', posLeft);
        
        bCreateTriangle = !gYButtonDown;
        createTrailGlowstick(posLeft, COLOR_LEFT, lastPosLeft, "left", velLeft,bCreateTriangle)

      }

      if (gTriggerRightDown){

        var ballRight = document.querySelector('#sphere-right');
        ballRight.setAttribute("position",posRight)

        //first see if last is different enough from pos
        var distance = lastPosRight.distanceTo(posRight)
        //console.log("distance:" + d)
        if (distance > 0.01){
          document.querySelector('#glowstick-right-1').object3D.getWorldPosition(lastPosRight);
        }
        var eRight = document.querySelector('#glowstick-right'); 
        eRight.setAttribute('position', posRight);
        
        bCreateTriangle = !gBButtonDown;
        createTrailGlowstick(posRight, COLOR_RIGHT, lastPosRight, "right", velRight,bCreateTriangle)
      }


      // var cursor = document.querySelector('#a-cursor');
      // if (cursor.components.raycaster.intersections.length >0 ){
      //   var posCursor = cursor.components.raycaster.intersections[0].point;

      //   velCursor = calcVelocity(aPosCursor, posCursor);
      // }
          
 
    }, TICKS_PER_FRAME);

    



  </script>


  </head>
  <body>
    <a-scene
      renderer="colorManagement: true;"
      cursor="rayOrigin: mouse"
      raycaster="objects: [cube]" fog="color: #bc483e; near: 0; far: 65;">
      
      <a-assets>
        <a-mixin id="cube"
                cursor-listener
                 geometry="primitive: box; height: 0.30; width: 0.30; depth: 0.30"
                 material="color: #EF2DFF;"></a-mixin>
        
      </a-assets>
      <a-assets>
        <a-asset-item id="ground" src="https://cdn.aframe.io/examples/tracked-controls/ground.glb"></a-asset-item>
     </a-assets>

     <!-- <a-entity id="point-1-right"   position="0 0 0" material="color: purple;" geometry="primitive: box; height: 0.10; width: 0.10; depth: 0.10"></a-entity>
     <a-entity id="point-2-right"  position="0 0 0" material="color: orange;" geometry="primitive: box; height: 0.10; width: 0.10; depth: 0.10"></a-entity>
      -->

    <a-entity id="glowstick-left" position="0 0 0">
     
      <a-entity id="glowstick-left-1" position="0 0 0" material="visible:false; color: purple;" geometry="primitive: box; height: 0.03; width: 0.03; depth: 0.03"></a-entity>
      <a-entity id="glowstick-left-2" position="0 0.15 -0.1" rotation="0 0 0" material="visible:true; color: white;" geometry="primitive: box; height: 0.005; width: 0.005; depth: 0.005"></a-entity>
    
      <a-entity light="type: point; color: #ffffff; intensity: 0.5; distance: 10; decay: 5;" position="0 0 0"></a-entity>
         
    </a-entity>

    <a-entity id="glowstick-right" position="0 0 0">
     <a-entity id="glowstick-right-1" position="0 0 0" material="visible:false; color: purple;" geometry="primitive: box; height: 0.03; width: 0.03; depth: 0.03"></a-entity>
     <a-entity id="glowstick-right-2" position="0 0.15 -0.1" rotation="0 0 0" material="visible:true; color: white;" geometry="primitive: box; height: 0.001; width: 0.001; depth: 0.001"></a-entity>
    
     <a-entity light="type: point; color: #ffffff; intensity: 0.5; distance: 10; decay: 5;" position="0 0 0"></a-entity>
         
    </a-entity>

    <a-sphere id="sphere-left" color="#0000cc" materialX="shader:flat;" radius="0.1" geometry="segmentsHeight:9; segmentsWidth:9;" position="-0.2 0.15 -0.1" ></a-sphere>
    <a-sphere id="sphere-right" color="#006699"  materialX="shader:flat;" radius="0.1" geometry="segmentsHeight:9; segmentsWidth:9;"  position="0.2 0.15 -0.1" ></a-sphere>

      <!-- A-Frame cubes -->
      <a-entity position="0 0 -0.5">

        <a-entity id="marker" cursor-listener class="cube" mixin="cube" position="0 1.95 0" material="color: #999999;visible:false;"></a-entity>
        
        

        <!-- <a-entity class="cube" material="color: #999999;" mixin="cube" position="-0.30 1.65 0"></a-entity> -->

        <!-- Environment -->
        <a-entity id="sky" cursor-listener
                  geometry="primitive: sphere; radius: 65;"
                  material="shader: skyGradient; colorTop: #353449; colorBottom: #BC483E; side: back"></a-entity>
         <a-entity ground cursor-listener></a-entity>
         
         <a-entity light="type: point; color: #f4f4f4; intensity: 0.1; distance: 0" position="-2.5 1.2 2.2"></a-entity>
         <a-entity light="type: point; color: #f4f4f4; intensity: 0.1; distance: 0" position="-20 -7 -40"></a-entity>
         <a-entity light="type: ambient; color: #f4f4f4; intensity: 0.25;" position="-8 10 -18"></a-entity>
      </a-entity>

      <!-- Hands -->
      <!-- <a-entity hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc" aabb-collider="objects: .cube;" grab></a-entity>
      <a-entity hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc" aabb-collider="objects: .cube;" grab></a-entity> -->
      <a-entity oculus-touch-controls="hand: left" id="hand-left" button-listener-left></a-entity>
      <a-entity oculus-touch-controls="hand: right" id="hand-right"  button-listener-right></a-entity>

      <a-entity position="0 1.6 2" camera look-controls wasd-controls>
        <a-entity id="a-cursor" cursor="fuse: true; fuseTimeout: 500"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: black; shader: flat; visible:false;">
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
